# AI-Trader A股市场适配方案

## 一、方案概述

### 1.1 适配目标

将现有基于NASDAQ 100的AI交易系统适配到中国A股市场，实现：
- 支持A股交易规则与市场特性
- 集成A股特有的数据源（北向资金、融资融券、券商研报等）
- 实现基于"多维共识"的选股策略
- 提供完整的历史回测能力

### 1.2 核心变化

| 维度 | 原NASDAQ系统 | A股适配系统 |
|------|-------------|-----------|
| 交易规则 | T+0，无涨跌幅限制 | T+1，±10%涨跌停（科创板/创业板±20%） |
| 交易时间 | 09:30-16:00（美东） | 09:30-11:30，13:00-15:00（北京） |
| 股票代码 | AAPL, MSFT等字母代码 | 600001.SH, 000001.SZ等数字代码 |
| 数据源 | Alpha Vantage | Tushare / AkShare / 东方财富API |
| 市场情绪指标 | 无 | 北向资金、融资融券余额、券商评级 |
| 选股逻辑 | AI自主决策 | 多维共识筛选 + AI优化 |

## 二、数据层适配方案

### 2.1 数据源替换策略

#### 2.1.1 历史行情数据

**原有实现**：
- 使用Alpha Vantage API获取NASDAQ股票OHLCV数据
- 数据格式：JSON，包含Time Series (Daily)和Meta Data

**A股适配方案**：

采用 **Tushare Pro** 作为主数据源（备选：AkShare、东方财富Quantaxis）

| 数据类型 | API接口 | 字段映射 |
|---------|---------|---------|
| 日线行情 | `pro.daily()` | ts_code→symbol, trade_date→date, open/high/low/close/vol→ohlcv |
| 分钟线 | `pro.min()` | 同上，增加时间戳字段 |
| 复权因子 | `pro.adj_factor()` | 用于计算前复权价格 |

**数据存储格式**：
- 保持现有 `merged.jsonl` 格式，便于兼容现有代码
- 股票代码格式：`600001.SH`（上交所）、`000001.SZ`（深交所）
- 时间格式：保持 `YYYY-MM-DD` 和 `YYYY-MM-DD HH:MM:SS`

#### 2.1.2 A股特色数据

新增数据源以支持"多维共识"选股：

| 数据维度 | 数据源 | 更新频率 | 用途 |
|---------|-------|---------|------|
| 北向资金流向 | Tushare `moneyflow_hsgt()` | 每日 | 资金共识判断 |
| 融资融券数据 | Tushare `margin_detail()` | 每日 | 资金共识判断 |
| 券商评级 | Tushare `broker_recommend()` | 每周 | 逻辑共识判断 |
| 行业板块热度 | Tushare `ths_index()` + `concept_detail()` | 每日 | 情绪共识判断 |
| 技术指标 | 本地计算（基于OHLCV） | 实时 | 技术共识判断 |
| 市场情绪 | 自定义爬虫（雪球、东方财富吧） | 每日 | 情绪共识补充 |

### 2.2 数据获取工具改造

#### 2.2.1 `data/get_daily_price.py` 改造

**变更内容**：

需要创建新的数据获取脚本 `data/get_astock_data.py`：

- 替换Alpha Vantage为Tushare Pro
- 支持A股代码格式转换
- 增加数据完整性校验（处理停牌、未上市等情况）
- 支持增量更新与全量下载

**关键逻辑**：

```
获取股票列表
  ↓
遍历每只股票
  ↓
调用 Tushare API 获取历史数据
  ↓
数据清洗：
  - 处理停牌日期（填充或标记）
  - 计算复权价格
  - 过滤ST、退市股票
  ↓
转换为统一JSON格式
  ↓
写入 merged.jsonl
```

#### 2.2.2 新增 `data/get_consensus_data.py`

用于获取A股特色的共识数据：

- 北向资金流向：获取沪股通/深股通每日净买入额
- 融资融券：获取融资余额变化率
- 券商评级：统计最近30天评级次数与平均目标价
- 行业热度：计算行业指数涨幅与成交量

**数据输出格式**：

独立存储为 `data/consensus_data.jsonl`，每行包含：
```
{
  "date": "2025-01-15",
  "symbol": "600519.SH",
  "northbound_flow": 120000000,  # 北向资金净买入（元）
  "margin_balance_chg": 0.05,    # 融资余额变化率
  "broker_recommend_count": 12,   # 券商推荐次数
  "industry": "白酒",
  "industry_heat": 0.85           # 行业热度分数（0-1）
}
```

### 2.3 数据存储结构

```
data/
├── merged.jsonl                    # 主行情数据（改造）
├── consensus_data.jsonl            # 共识数据（新增）
├── astock_list.json                # A股股票列表（新增）
├── industry_mapping.json           # 行业分类映射（新增）
├── get_astock_data.py              # A股行情获取（新增）
├── get_consensus_data.py           # 共识数据获取（新增）
└── agent_data/                     # 保持不变
```

## 三、MCP工具层适配方案

### 3.1 价格查询工具改造

#### 3.1.1 `agent_tools/tool_get_price_local.py`

**需要变更的内容**：

| 项目 | 原实现 | A股适配 |
|------|-------|--------|
| 股票代码验证 | 字母代码 | 数字代码 + 交易所后缀 |
| 数据键名 | `Time Series (Daily)` | 保持不变（数据获取时已转换） |
| 停牌处理 | 无 | 返回停牌标识，禁止交易 |
| 涨跌停处理 | 无 | 检测涨跌停状态，限制交易 |

**新增功能**：

- `get_stock_status()`：查询股票当日状态（正常/停牌/涨停/跌停/ST）
- `get_volume_ratio()`：获取量比数据
- `get_turnover_rate()`：获取换手率

#### 3.1.2 新增 `agent_tools/tool_get_consensus.py`

提供共识数据查询能力：

**工具函数列表**：

| 函数名 | 功能 | 返回示例 |
|-------|------|---------|
| `get_northbound_flow(symbol, date)` | 获取北向资金流向 | `{"net_buy": 120000000, "rank": 5}` |
| `get_margin_info(symbol, date)` | 获取融资融券数据 | `{"margin_balance": 5000000000, "chg_rate": 0.05}` |
| `get_broker_ratings(symbol, days)` | 获取券商评级汇总 | `{"buy_count": 10, "avg_target_price": 150.0}` |
| `get_industry_heat(symbol, date)` | 获取所属行业热度 | `{"industry": "白酒", "heat_score": 0.85}` |
| `get_technical_consensus(symbol, date)` | 获取技术指标状态 | `{"year_high": true, "ma_golden_cross": true}` |

### 3.2 搜索工具改造

#### 3.2.1 `agent_tools/tool_jina_search.py`

**需要调整**：

- 搜索关键词本地化：增加中文市场术语
- 信息源过滤：优先抓取财联社、证券时报、东方财富等A股主流媒体
- 时间戳处理：支持中国时区解析

**新增搜索模板**：

```
查询类型：
1. 行业政策搜索 → "【行业名】 政策 利好 site:xinhua.net OR site:gov.cn"
2. 公司公告搜索 → "【股票代码】 公告 site:cninfo.com.cn"
3. 券商研报搜索 → "【股票简称】 研报 推荐 site:eastmoney.com"
4. 市场情绪搜索 → "【概念板块】 资金 流入"
```

### 3.3 交易工具改造

#### 3.3.1 `agent_tools/tool_trade.py`

**需要增加的交易规则校验**：

| 规则 | 检查逻辑 | 错误提示 |
|------|---------|---------|
| T+1限制 | 检查买入日期，当日买入不可卖出 | "T+1规则：今日买入股票明日才可卖出" |
| 涨停限制 | 买入前检查是否涨停 | "该股票已涨停，无法买入" |
| 跌停限制 | 卖出前检查是否跌停 | "该股票已跌停，无法卖出" |
| 最小交易单位 | 买入必须是100股整数倍 | "买入数量必须为100的整数倍（1手=100股）" |
| 停牌检查 | 查询股票状态 | "该股票当前停牌，无法交易" |

**函数签名变更**：

`buy()` 和 `sell()` 函数需要在执行前调用：
- `validate_trade_rules(symbol, date, action, amount)`

### 3.4 新增 `agent_tools/tool_consensus_filter.py`

提供基于多维共识的股票筛选工具：

**核心函数**：

`filter_by_consensus(date, min_consensus_score)` 

**筛选逻辑流程**：

```
输入：交易日期、最小共识分数（0-100）
  ↓
计算各维度共识分数：
  - 技术共识：是否创年内新高、均线多头排列（20分）
  - 资金共识：北向+融资双流入且幅度>阈值（30分）
  - 逻辑共识：行业热度排名前30% 且 券商推荐>5次（30分）
  - 情绪共识：社交媒体讨论热度（20分）
  ↓
总分 = 技术共识 + 资金共识 + 逻辑共识 + 情绪共识
  ↓
筛选：总分 >= min_consensus_score
  ↓
返回：符合条件的股票列表（按分数降序）
```

**返回格式示例**：

```
[
  {
    "symbol": "600519.SH",
    "name": "贵州茅台",
    "consensus_score": 85,
    "details": {
      "technical": 18,
      "capital": 28,
      "logic": 30,
      "sentiment": 19
    }
  },
  ...
]
```

## 四、提示词（Prompt）层适配方案

### 4.1 系统提示词改造

#### 4.1.1 `prompts/agent_prompt.py` 变更

**主要调整点**：

| 模块 | 原内容 | A股适配内容 |
|------|-------|-----------|
| 股票池 | `all_nasdaq_100_symbols` | `all_astock_symbols`（沪深300或自定义池） |
| 市场规则描述 | "maximize returns" | 增加"遵守A股T+1、涨跌停规则" |
| 交易时间提示 | 无 | "交易时间：9:30-11:30, 13:00-15:00" |
| 共识策略提示 | 无 | 新增"优先选择高共识股票"指引 |

**新增提示词段落**：

```
市场规则与约束：
- 交易制度：实行T+1，当日买入的股票次日才可卖出
- 涨跌幅限制：主板±10%，科创板/创业板±20%，ST股票±5%
- 最小交易单位：买入必须是100股（1手）的整数倍，卖出可零股
- 停牌规则：停牌股票无法交易，需检查股票状态

选股策略指引：
你应该优先关注满足"多维共识"的股票：
1. 技术共识：股价创年内新高，突破关键压力位
2. 资金共识：北向资金和融资资金同步大幅流入（单日流入>5000万）
3. 逻辑共识：所属行业为当前市场热点（行业指数涨幅前30%），且近30天有5家以上券商发布买入评级
4. 情绪共识：社交媒体讨论热度高，散户关注度上升

使用工具 filter_by_consensus 可以获取当日高共识股票列表，建议优先从中选择。

风险提示：
- 避免追高涨停股，避免接盘跌停股
- 注意ST股票风险，避免配置
- 分散投资，单只股票持仓不超过总资产30%
```

### 4.2 动态提示词生成

**新增函数**：`get_consensus_prompt(date)`

根据当日市场情况动态生成提示：

```
今日市场环境：
- 市场情绪：【牛市/震荡/熊市】（根据上证指数MA状态判断）
- 成交量：【放量/缩量】（对比5日均量）
- 热点板块：【新能源、半导体、医药】（当日涨幅前3行业）
- 北向资金：【净流入XXX亿】或【净流出XXX亿】

高共识股票推荐（共识分>80）：
1. 600519.SH 贵州茅台 - 共识分85（技术18/资金28/逻辑30/情绪19）
2. 000858.SZ 五粮液 - 共识分82
...
```

## 五、回测系统设计方案

### 5.1 回测框架架构

#### 5.1.1 回测流程设计

```
用户配置回测参数
  ↓
加载历史数据（行情+共识）
  ↓
初始化虚拟账户（现金、持仓）
  ↓
按日期循环执行：
  │
  ├─ 更新当日环境（价格、共识数据）
  │
  ├─ 调用AI Agent决策
  │
  ├─ 执行交易指令（模拟成交）
  │
  ├─ 更新持仓与资金
  │
  └─ 记录交易日志
  ↓
生成回测报告：
  - 收益曲线
  - 最大回撤
  - 夏普比率
  - 胜率/盈亏比
  - 交易明细
```

#### 5.1.2 回测配置结构

新增配置文件 `configs/backtest_config.json`：

```
{
  "backtest_mode": true,
  "date_range": {
    "start_date": "2024-01-01",
    "end_date": "2024-12-31"
  },
  "initial_capital": 1000000,
  "stock_pool": "hs300",  // 沪深300 | zz500 | custom
  "custom_pool": [],      // 自定义股票池
  "consensus_config": {
    "enabled": true,
    "min_score": 70,
    "weights": {
      "technical": 0.2,
      "capital": 0.3,
      "logic": 0.3,
      "sentiment": 0.2
    }
  },
  "risk_control": {
    "max_position_ratio": 0.3,  // 单股最大仓位
    "max_drawdown_stop": 0.15,  // 最大回撤止损
    "daily_loss_limit": 0.05    // 单日最大亏损
  }
}
```

### 5.2 回测引擎实现

#### 5.2.1 新增 `tools/backtest_engine.py`

**核心类**：`BacktestEngine`

**关键方法**：

| 方法 | 功能 | 说明 |
|------|------|------|
| `load_historical_data()` | 加载历史数据 | 从merged.jsonl和consensus_data.jsonl读取 |
| `simulate_trading_day()` | 模拟单日交易 | 调用Agent，执行交易，更新状态 |
| `check_trade_validity()` | 交易合规检查 | 验证涨跌停、T+1、资金充足性 |
| `execute_order()` | 模拟成交 | 按开盘价或指定价格成交 |
| `calculate_metrics()` | 计算绩效指标 | 收益率、夏普、最大回撤、胜率 |
| `generate_report()` | 生成回测报告 | 输出HTML/PDF报告 |

#### 5.2.2 新增 `agent/base_agent/backtest_agent.py`

继承 `BaseAgent`，重写交易执行逻辑：

**关键差异**：

- 不依赖实时MCP服务，使用本地历史数据
- 支持快速模拟（跳过LLM调用延迟）
- 强制按时间顺序执行，防止未来信息泄露
- 增加时间旅行验证（确保决策时刻只能访问历史数据）

### 5.3 回测结果输出

#### 5.3.1 结果存储

生成文件结构：

```
data/backtest_results/
├── {model_name}_{date_range}/
│   ├── trades.jsonl          # 交易明细
│   ├── daily_positions.jsonl # 每日持仓
│   ├── metrics.json          # 绩效指标
│   └── report.html           # 可视化报告
```

#### 5.3.2 绩效指标定义

| 指标 | 计算公式 | 说明 |
|------|---------|------|
| 总收益率 | (期末资产 - 期初资产) / 期初资产 | 百分比 |
| 年化收益率 | (1 + 总收益率)^(365/天数) - 1 | 百分比 |
| 最大回撤 | max((peak - valley) / peak) | 百分比 |
| 夏普比率 | (年化收益 - 无风险利率) / 收益波动率 | 数值 |
| 胜率 | 盈利交易次数 / 总交易次数 | 百分比 |
| 盈亏比 | 平均盈利 / 平均亏损 | 比值 |

#### 5.3.3 可视化报告内容

使用 `matplotlib` 或 `plotly` 生成：

- 资金曲线图（对比基准指数）
- 回撤曲线图
- 持仓占比饼图
- 行业分布图
- 月度收益热力图
- 交易次数统计

## 六、配置文件适配方案

### 6.1 `configs/default_config.json` 变更

**新增字段**：

```
{
  "market": "a_stock",  // 新增：市场类型
  "trading_rules": {    // 新增：交易规则配置
    "t_plus": 1,
    "price_limit": {
      "main_board": 0.1,
      "star_market": 0.2,
      "st_stock": 0.05
    },
    "min_unit": 100
  },
  "data_source": {      // 新增：数据源配置
    "provider": "tushare",
    "api_token": "${TUSHARE_TOKEN}"
  },
  "consensus_filter": { // 新增：共识筛选配置
    "enabled": true,
    "min_score": 70
  },
  "stock_pool": "custom",  // 修改：股票池
  "custom_stocks": [       // 新增：自定义股票列表
    "600519.SH", "000858.SZ", ...
  ]
}
```

### 6.2 环境变量补充

新增 `.env` 文件配置项：

```
# A股数据源
TUSHARE_TOKEN=your_tushare_token
AKSHARE_ENABLED=false

# 共识数据爬虫
EASTMONEY_COOKIES=...
XUEQIU_TOKEN=...

# 市场参数
MARKET=a_stock
TIMEZONE=Asia/Shanghai
TRADING_CALENDAR=SSE  # 上交所交易日历
```

## 七、实施路径与优先级

### 7.1 实施阶段

#### 阶段一：基础适配（核心功能）

**目标**：实现基本的A股交易能力

**任务清单**：

1. 数据层
   - 实现 `get_astock_data.py`（Tushare接入）
   - 修改 `tool_get_price_local.py`（支持A股代码）
   - 修改数据存储格式

2. 交易层
   - 修改 `tool_trade.py`（增加A股交易规则）
   - 实现T+1、涨跌停校验

3. 提示词层
   - 修改 `agent_prompt.py`（股票池、市场规则）

**验收标准**：能够运行单日A股模拟交易

#### 阶段二：共识系统（差异化功能）

**目标**：实现多维共识选股能力

**任务清单**：

1. 数据获取
   - 实现 `get_consensus_data.py`
   - 接入北向资金、融资融券、券商评级API

2. MCP工具
   - 实现 `tool_get_consensus.py`
   - 实现 `tool_consensus_filter.py`

3. 提示词优化
   - 增加共识策略指引
   - 实现 `get_consensus_prompt()`

**验收标准**：AI能够基于共识数据筛选股票

#### 阶段三：回测系统（验证功能）

**目标**：提供历史回测与策略验证

**任务清单**：

1. 回测引擎
   - 实现 `backtest_engine.py`
   - 实现 `backtest_agent.py`

2. 报告生成
   - 实现绩效计算
   - 实现可视化报告

**验收标准**：完成2024全年回测并生成报告

### 7.2 风险控制点

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 数据源API限流 | 数据获取失败 | 增加重试机制、使用多数据源备份 |
| 停牌数据缺失 | 交易逻辑错误 | 交易前强制检查股票状态 |
| 涨跌停误判 | 模拟成交错误 | 使用精确的涨跌停价格计算（前收盘价×1.1） |
| 未来信息泄露 | 回测结果失真 | 严格的时间戳校验，禁止访问T日后数据 |
| LLM幻觉输出 | 违规交易指令 | 交易前进行多层规则校验 |

### 7.3 测试策略

**单元测试**：

- 数据获取函数（模拟API返回）
- 交易规则校验（边界用例：涨跌停、停牌、T+1）
- 共识分数计算（各维度权重准确性）

**集成测试**：

- 完整交易流程（数据→决策→执行→记录）
- MCP工具链调用（多工具协同）

**回测验证**：

- 历史数据完整性检查
- 时间旅行测试（确保无未来数据）
- 对比已知策略结果（如双均线策略）

## 八、附录

### 8.1 A股股票池推荐方案

| 股票池 | 数量 | 说明 | 适用场景 |
|-------|------|------|---------|
| 沪深300 | 300 | 市值最大、流动性最好 | 稳健型策略 |
| 中证500 | 500 | 中盘股，弹性更大 | 成长型策略 |
| 科创50 | 50 | 科技创新企业 | 激进型策略 |
| 自定义高共识池 | 动态 | 每日筛选共识分>80的股票 | 轮动策略 |

### 8.2 数据源API对比

| 数据源 | 优点 | 缺点 | 费用 |
|-------|------|------|------|
| Tushare Pro | 数据全面、接口稳定、有共识数据 | 需要积分权限 | 免费（限额）+ 付费 |
| AkShare | 完全免费、无需注册 | 稳定性较差、无共识数据 | 免费 |
| 东方财富API | 实时性好、免费 | 非官方接口、可能失效 | 免费 |
| Wind/同花顺 | 专业级数据 | 费用高昂 | 付费（年费数万） |

**推荐方案**：Tushare Pro（主） + AkShare（备）

### 8.3 关键技术决策

| 决策点 | 方案A | 方案B | 选择 | 理由 |
|-------|-------|-------|------|------|
| 数据存储 | 继续使用JSONL | 迁移到SQLite | A | 保持代码兼容性，JSONL足够轻量 |
| 共识计算 | 实时计算 | 预计算缓存 | B | 减少MCP调用延迟，提高决策效率 |
| 回测加速 | 保留LLM调用 | 录制回放模式 | A | 保证回测真实性，可选加速参数 |
| 停牌处理 | 跳过交易 | 使用前收盘价 | A | 符合实际交易规则 |
| 复权方式 | 前复权 | 后复权 | A | 便于计算历史收益，主流选择 |

### 8.4 依赖包新增

需要在 `requirements.txt` 中新增：

```
tushare>=1.2.89
akshare>=1.11.0
pandas>=2.0.0
numpy>=1.24.0
matplotlib>=3.7.0
plotly>=5.14.0
```plotly>=5.14.0
